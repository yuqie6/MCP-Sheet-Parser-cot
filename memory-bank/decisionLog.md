# Decision Log

This file records architectural and implementation decisions using a structured format.

## 核心架构决策

### 决策 1: 项目重启策略
**日期:** 2025-07-11  
**决策:** 清空所有代码，基于经验教训重新开始

**背景:**
- 前期开发中出现了代码膨胀和过度复杂化问题
- ParsingService类变得臃肿，违背了单一职责原则
- 重构过程中引入了递归错误和逻辑混乱
- 代码质量下降，维护成本增加

**可选方案:**
1. **修复现有代码** - 逐步重构现有实现
   - 优点: 保留已有功能，开发连续性
   - 缺点: 技术债务积累，架构问题难以根本解决
2. **完全重写** - 清空代码，基于经验重新设计
   - 优点: 架构清晰，代码质量高，避免技术债务
   - 缺点: 短期内功能缺失，需要重新实现

**最终决策:** 选择完全重写

**理由:**
- 现有代码的架构问题已经影响到开发效率
- 重构成本可能超过重写成本
- 有了前期的经验和教训，重写可以避免同样的错误
- 清晰的架构对长期维护更有价值

**实施计划:**
1. 保留测试数据和经验总结
2. 重写项目规范和架构设计文档
3. 采用最小可行架构，渐进式开发
4. 严格控制代码复杂度

---

### 决策 2: 架构简化策略
**日期:** 2025-07-11  
**决策:** 采用最小可行架构，避免过度工程化

**背景:**
- 前期设计过于复杂，抽象层次过多
- 代码可读性和维护性下降
- 开发效率受到影响

**设计原则:**
- **简单性优于复杂性** - 选择最简单的可行方案
- **具体实现优于抽象接口** - 避免不必要的抽象
- **组合优于继承** - 减少继承层次
- **功能性优于技术炫技** - 专注解决实际问题

**架构决策:**
- 三层架构：MCP Interface → Business Service → Implementation
- 每层职责单一，接口简洁
- 避免深层继承和复杂抽象
- 优先使用组合和依赖注入

---

### 决策 3: 文件格式支持策略
**日期:** 2025-07-11  
**决策:** 优先支持主要格式，渐进式扩展

**支持优先级:**
1. **P0 (必须):** `.xlsx`, `.csv` - 覆盖90%的使用场景
2. **P1 (重要):** `.xls` - 传统Excel格式
3. **P2 (可选):** `.xlsb`, `.xlsm`, `.et` 等 - 特殊需求

**理由:**
- 避免一开始就支持所有格式导致的复杂性
- 先保证核心格式的高质量支持
- 根据实际需求决定是否扩展其他格式

**实施策略:**
- 设计可扩展的Parser接口
- 每个格式独立实现，互不影响
- 通过工厂模式管理不同解析器

---

### 决策 4: 性能优化策略
**日期:** 2025-07-11  
**决策:** 智能处理策略，避免一刀切的限制

**背景:**
- 前期的行数限制方案影响用户体验
- 需要平衡性能和功能完整性

**解决方案:**
- **智能判断** - 根据文件大小选择处理策略
- **多种选择** - 提供内容返回和文件输出两种模式
- **用户友好** - 提供清晰的建议和选择

**处理策略:**
- 小文件 (<100行): 直接返回HTML内容
- 中文件 (100-1000行): 返回内容 + 性能建议
- 大文件 (>1000行): 推荐文件输出模式

---

### 决策 5: 工具接口设计
**日期:** 2025-07-11  
**决策:** 核心工具 + 专业工具的双层设计

**工具分层:**
- **核心工具** - 满足90%的使用场景
  - `convert_file_to_html` - 基础转换
  - `convert_file_to_html_file` - 文件输出
  - `get_table_summary` - 表格概览
- **专业工具** - 满足高级需求
  - `get_sheet_metadata` - 元数据
  - `parse_sheet_to_json` - JSON转换
  - `convert_json_to_html` - JSON到HTML

**设计原则:**
- 核心工具简单易用，覆盖常见需求
- 专业工具提供灵活性，支持复杂场景
- 接口设计一致，参数命名规范
- 错误处理统一，用户体验友好

---

### 决策 6: 数据模型设计
**日期:** 2025-07-11  
**决策:** 简化数据模型，专注核心属性

**模型结构:**
```python
Cell -> Row -> Sheet
Style (独立的样式对象)
```

**设计原则:**
- 使用dataclass简化定义
- 只包含必需的属性
- 支持可选的样式信息
- 便于序列化和测试

**扩展策略:**
- 通过Optional字段支持新属性
- 保持向后兼容性
- 避免过度复杂的嵌套结构

---

### 决策 7: 错误处理策略
**日期:** 2025-07-11  
**决策:** 统一的错误处理和用户友好的反馈

**错误处理原则:**
- **优雅降级** - 部分错误不影响整体功能
- **清晰反馈** - 提供明确的错误信息和建议
- **统一格式** - 所有工具使用相同的错误响应格式
- **日志记录** - 详细记录错误信息用于调试

**错误响应格式:**
```json
{
  "status": "error",
  "error_type": "file_not_found",
  "message": "用户友好的错误信息",
  "suggestion": "具体的解决建议"
}
```

---

### 决策 8: 测试策略
**日期:** 2025-07-11  
**决策:** 测试驱动开发，重点覆盖核心功能

**测试层次:**
- **单元测试** - 每个模块的核心功能
- **集成测试** - 端到端的转换流程
- **性能测试** - 不同文件大小的处理能力

**测试数据:**
- 保留现有的CSV测试文件
- 创建不同复杂度的测试用例
- 包含边界情况和异常情况

**测试原则:**
- 先写测试，再写实现
- 测试用例要简单明确
- 重点测试核心功能和边界情况
- 保持测试代码的可维护性

---

## 经验教训总结

### 避免的错误
1. **过度工程化** - 不要为了技术而技术
2. **功能膨胀** - 专注核心需求，拒绝非必要功能
3. **复杂抽象** - 具体实现优于抽象接口
4. **代码堆积** - 重构应该简化而不是复杂化

### 成功的实践
1. **用户反馈** - 及时响应用户需求和建议
2. **渐进式开发** - 小步快跑，频繁验证
3. **文档先行** - 先明确需求和设计，再开始编码
4. **质量优先** - 代码质量比功能数量更重要

### 持续改进
1. **定期回顾** - 定期检查代码质量和架构合理性
2. **用户导向** - 始终以用户需求为导向
3. **简洁性** - 持续简化代码和架构
4. **可维护性** - 优先考虑长期维护成本
---
### Architecture Decision
[2025-07-11 14:57:06] - 完成基于 `spec.md` 的详细核心架构设计，定义了最终的目录结构、类和接口。准备更新 `systemPatterns.md` 以反映此设计。

**Decision Background:**
此架构决策是基于先前已批准的 `spec.md` 文件，该文件为所有核心模块提供了伪代码级别的规范。为了将这些规范转化为可执行的、结构化的代码，需要一个明确的、与三层架构原则（在 `systemPatterns.md` 中定义）相符的详细架构。此决策旨在将抽象的规范具体化为项目蓝图。

**Considered Options:**
- Option A: 采用更扁平的结构，将所有逻辑直接放在 `main.py` 中。
  - 优点: 快速实现，初期简单。
  - 缺点: 难以维护和扩展，违反单一职责原则。
- Option B: 采用严格的三层架构，包含独立的接口、服务和实现层。
  - 优点: 结构清晰，高内聚低耦合，易于测试和扩展。
  - 缺点: 需要更多的前期设计和文件组织工作。
- Final Choice: Option B。这与 `systemPatterns.md` 中既定的“最小可行架构”和“单一职责”原则完全一致，为项目的长期健康发展奠定了坚实基础。

**Implementation Details:**
- Affected Modules: `src/` 目录下的所有模块，包括 `mcp_server`, `services`, `parsers`, `converters`, `models`。
- Migration Strategy: 由于是项目重启后的首次详细设计，不存在从旧架构迁移的问题。所有新代码将直接遵循此架构。
- Risk Assessment: 主要风险在于过度设计。通过严格遵循“最小可行架构”原则，只实现 `spec.md` 中定义的必要组件，可以有效缓解此风险。

**Impact Assessment:**
- Performance Impact: 模块化设计对性能无负面影响，清晰的结构反而有助于未来进行针对性的性能优化。
- Maintainability Impact: 极大地提高了可维护性。每个模块职责单一，便于理解、修改和测试。
- Scalability Impact: 架构具有良好的可扩展性。例如，通过在 `parsers` 目录中添加新文件，可以轻松支持新的文件格式，而无需改动核心业务逻辑。

---

### Architecture Decision
[2025-07-12 01:54:14] - 完善MCP工具架构设计：确定了6个工具的完整架构，包括JSON返回工具和完美HTML复刻工具，形成三种工作流程以满足不同使用场景

**Decision Background:**
在项目开发过程中，我们面临一个关键的设计问题：如何平衡MCP工具的功能完整性与LLM上下文限制。原始设计中，直接返回HTML内容可能导致大型表格超出上下文限制，而仅返回文件路径又无法让LLM直接分析数据。经过深入分析，我们需要一个既能满足LLM分析需求，又能实现完美样式复刻的综合解决方案。

**Considered Options:**
- Option A: 智能双模式策略 - 根据文件大小选择返回HTML内容或文件路径
  - 优点: 平衡了功能性和性能，实现简单
  - 缺点: 阈值设定可能不够灵活，无法满足完美复刻需求
- Option B: 分层返回策略 - 总是返回摘要，根据需求提供完整内容
  - 优点: 给用户选择权，灵活性高
  - 缺点: 接口复杂度增加，用户体验可能混乱
- Option C: JSON + HTML混合架构 - 提供JSON给LLM分析，生成完美HTML文件
  - 优点: JSON对LLM友好且紧凑，HTML文件实现完美复刻，工具链完整
  - 缺点: 需要实现更多工具，架构复杂度适中增加
- Final Choice: Option C - JSON + HTML混合架构

**Implementation Details:**
- Affected Modules:
  - `mcp_server/tools.py` - 新增6个MCP工具定义
  - `services/sheet_service.py` - 新增JSON序列化和HTML完美复刻功能
  - `converters/html_converter.py` - 增强HTML生成能力，支持完美样式复刻
  - `converters/json_converter.py` - 新增JSON转换器模块
- Migration Strategy:
  - 保持现有架构不变，扩展新功能
  - 新增JSON转换器和增强HTML转换器
  - 实现6个MCP工具，形成完整工具链
- Risk Assessment:
  - 工具数量增加可能导致用户选择困难 - 通过清晰的工具分类和使用指南缓解
  - JSON和HTML双重转换可能影响性能 - 通过智能缓存和优化算法缓解

**Impact Assessment:**
- Performance Impact: JSON格式比HTML更紧凑，减少token消耗；智能工具选择避免不必要的处理；HTML优化技术实现87%大小减少目标
- Maintainability Impact: 工具职责清晰，每个工具专注特定场景；JSON作为中间格式便于测试和调试；模块化设计便于独立维护
- Scalability Impact: JSON格式易于扩展新字段；工具链设计支持新功能无缝集成；完美复刻能力为未来高级功能奠定基础

---

### Decision Record
[2025-07-12 02:02:15] - 基于甲方需求分析，确定项目实施策略：分阶段实现，重点关注样式保真度95%和观感专业，允许完全重构以实现完美整洁的最终答卷

**Decision Background:**
通过深入分析甲方需求文档，发现甲方强调"精准、高效"、"最大限度还原视觉效果"、"观感专业"等关键要求。甲方明确表示不需要向后兼容，只需要一份完美的、整洁的最终答卷，项目完全可以重构。这为我们提供了重新设计和优化的机会，可以专注于实现最高质量的解决方案。

**Available Options:**
- Option 1: 渐进式改进现有代码
  - Pros: 保持开发连续性，风险较低
  - Cons: 可能受限于现有架构，难以达到95%样式保真度
- Option 2: 完全重构，分阶段实现完美方案
  - Pros: 可以实现最优架构，达到95%样式保真度，代码整洁
  - Cons: 需要重新实现，开发工作量较大

**Final Decision:**
选择Option 2 - 完全重构，分阶段实现完美方案。基于甲方明确表示允许重构且不需要向后兼容的要求，我们将重新设计整个系统以实现最高质量的解决方案。

**Implementation Plan:**
- Step 1: 使用MCP任务管理工具制定详细的分阶段开发计划
- Step 2: 阶段1 - 实现核心功能（xlsx, csv + 95%样式保真度HTML转换 + 6个MCP工具）
- Step 3: 阶段2 - 扩展格式支持（xls, xlsb, xlsm等）
- Step 4: 阶段3 - 实现进阶功能（超链接、注释、图表转换）
- Validation Method: 每个阶段完成后进行样式保真度测试和性能测试

**Risks and Mitigation:**
- Risk 1: 重构可能导致开发时间延长 → Mitigation: 使用任务管理工具精确规划，分阶段交付
- Risk 2: 样式保真度95%目标可能难以达到 → Mitigation: 重点投入样式映射算法研发，建立样式测试基准