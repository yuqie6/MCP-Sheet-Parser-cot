# Product Context: MCP Sheet Parser Server

## 1. 项目愿景

创建一个**简洁、高效、可维护**的MCP服务器，专注于表格文件解析和HTML转换的核心功能。

**设计哲学：**
- **简单性优于复杂性** - 避免过度工程化
- **功能性优于技术炫技** - 专注解决实际问题
- **可维护性优于性能优化** - 清晰的代码胜过复杂的优化
- **渐进式开发** - 先让它工作，再让它更好

## 2. 核心功能需求

### 2.1 文件格式支持
**必须支持的格式：**
- `.xlsx` - 现代Excel格式（主要格式）
- `.csv` - 通用文本格式（简单格式）

**可选支持的格式（后期扩展）：**
- `.xls` - 传统Excel格式
- `.xlsb`, `.xlsm` - Excel二进制和宏格式
- `.et`, `.ett`, `.ets` - WPS格式

### 2.2 解析能力
**核心解析功能：**
- 读取工作表结构（行、列、单元格）
- 提取单元格数据（文本、数字、日期）
- 识别基本样式（字体、颜色、对齐）
- 处理单元格合并

**不包含的功能（避免复杂性）：**
- 公式计算
- 图表转换
- 宏处理
- 复杂格式化

### 2.3 HTML转换
**输出要求：**
- 生成标准HTML表格（`<table>`, `<tr>`, `<td>`）
- 基本CSS样式映射
- 保持数据完整性
- 支持单元格合并（`colspan`, `rowspan`）

**性能考虑：**
- 支持大文件处理（1000+行）
- 提供紧凑HTML模式（减少输出大小）
- 智能处理建议（大文件时推荐文件输出）

## 3. MCP工具接口设计

### 3.1 核心工具（90%使用场景）
1. **`parse_sheet_to_json`** - 解析为JSON格式，LLM友好
   - 返回结构化JSON数据给LLM分析
   - 包含完整数据、样式、合并信息
   - Token友好，紧凑格式

2. **`convert_json_to_html`** - JSON到完美HTML文件转换
   - 接收JSON数据，生成完美HTML文件
   - 95%样式保真度目标
   - 返回HTML文件路径

3. **`convert_file_to_html`** - 智能直接转换
   - 小文件返回HTML内容，大文件返回建议
   - 智能判断处理策略
   - 包含性能建议

### 3.2 专业工具（高级需求）
4. **`convert_file_to_html_file`** - 直接生成HTML文件
5. **`get_table_summary`** - 表格概览预览
6. **`get_sheet_metadata`** - 文件元数据

### 3.3 工作流程设计
**完美复刻流程：** 文件 → `parse_sheet_to_json` → LLM分析 → `convert_json_to_html` → 完美HTML文件
**快速转换流程：** 文件 → `convert_file_to_html` → 智能HTML输出
**预览分析流程：** 文件 → `get_table_summary` → 摘要信息

## 4. 技术规范

### 4.1 开发环境
- **语言：** Python 3.11+
- **包管理：** uv
- **MCP框架：** FastMCP
- **通信协议：** stdio

### 4.2 核心依赖
- `mcp` - MCP协议支持
- `openpyxl` - Excel文件解析
- `jinja2` - HTML模板渲染
- `pandas` - 数据处理（可选）

### 4.3 项目结构
```
src/
├── main.py                 # MCP服务器入口
├── mcp_server/             # MCP服务器实现 (接口层)
│   ├── __init__.py
│   └── tools.py            # 工具定义
├── services/               # 业务逻辑层
│   ├── __init__.py
│   └── sheet_service.py    # 核心业务服务
├── parsers/                # 解析器 (实现层)
│   ├── __init__.py
│   ├── base_parser.py      # 抽象基类
│   ├── xlsx_parser.py      # .xlsx解析器
│   ├── csv_parser.py       # .csv解析器
│   └── parser_factory.py   # 解析器工厂
├── converters/             # 转换器 (实现层)
│   ├── __init__.py
│   └── html_converter.py   # HTML转换器
├── models/                 # 数据模型 (实现层)
│   ├── __init__.py
│   └── table_model.py      # Sheet/Row/Cell/Style 定义
├── templates/              # HTML模板
│   └── table_template.html
└── exceptions/             # 自定义异常
    ├── __init__.py
    └── custom_exceptions.py
```

## 5. 质量标准

### 5.1 代码质量
- **简洁性：** 每个模块职责单一，代码易读
- **可测试性：** 核心功能有单元测试覆盖
- **错误处理：** 优雅的错误处理和用户反馈
- **文档：** 清晰的代码注释和API文档

### 5.2 性能标准
- **小文件（<100行）：** 响应时间 < 1秒
- **中文件（100-1000行）：** 响应时间 < 5秒
- **大文件（>1000行）：** 提供文件输出选项

### 5.3 用户体验
- **智能建议：** 根据文件大小推荐最佳处理方式
- **完整性保证：** 不截断用户数据
- **清晰反馈：** 明确的错误信息和处理建议

## 6. 开发原则

### 6.1 架构原则
- **最小可行架构：** 只实现必需的抽象层
- **单一职责：** 每个类和模块只做一件事
- **依赖注入：** 便于测试和扩展
- **配置外置：** 避免硬编码

### 6.2 开发流程
- **测试驱动：** 先写测试，再写实现
- **渐进式开发：** 小步快跑，频繁验证
- **持续重构：** 保持代码整洁
- **用户反馈：** 及时响应用户需求

## 7. 成功标准

### 7.1 功能标准
- ✅ 支持主要文件格式（xlsx, csv）
- ✅ 准确解析表格结构和数据
- ✅ 生成高质量HTML输出
- ✅ 处理大文件不出错

### 7.2 质量标准
- ✅ 代码简洁易维护
- ✅ 核心功能测试覆盖率 > 80%
- ✅ 用户体验友好
- ✅ 性能满足实际需求

### 7.3 可扩展性
- ✅ 易于添加新文件格式支持
- ✅ 易于扩展HTML输出功能
- ✅ 易于集成到其他系统
[2025-07-11 15:48:32] - New feature: 完成了 HtmlConverter 的 TDD 开发周期。创建了单元测试 tests/test_converters.py，并使用 Jinja2 模板实现了 src/converters/html_converter.py。所有测试均已通过。
[2025-07-11 14:57:06] - Architecture update: 完成基于 `spec.md` 的详细核心架构设计，定义了最终的目录结构、类和接口。准备更新 `systemPatterns.md` 以反映此设计。
[2025-07-11 15:32:35] - New feature: 实现了 XlsxParser，用于解析 .xlsx 文件。该解析器继承自 BaseParser，并使用 openpyxl 库。实现已通过所有相关单元测试。
[2025-07-12 01:54:14] - Architecture update: 完善MCP工具架构设计：确定了6个工具的完整架构，包括JSON返回工具和完美HTML复刻工具，形成三种工作流程以满足不同使用场景
[2025-07-12 02:30:59] - New feature: 完成样式提取算法增强，实现95%保真度目标。扩展Style数据模型支持14个样式属性，完善XlsxParser样式提取功能，创建6个单元测试验证功能，修复颜色处理问题，HTML输出现在包含正确的样式信息
[2025-07-12 02:40:26] - New feature: 完成JSON转换器和序列化功能实现。成功创建了JSONConverter类，实现了Sheet对象到JSON格式的完整序列化功能，包括样式去重机制、大小估算功能，创建了8个全面的单元测试，为LLM提供友好的数据格式
[2025-07-12 02:55:58] - New feature: 完成HTML优化和CSS类复用系统实现。成功重构HTMLConverter，实现CSS类复用算法、HTML压缩功能，在大型表格测试中达到75.23%的大小减少，创建8个单元测试验证功能，保持95%样式保真度